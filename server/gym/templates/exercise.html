{% extends "site/templates/base.html" %}
{% block title %}Exercise: {{ ex.name }}{% endblock %}

{% block head %}
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js'></script>
  <script src='/static/codemirror-compressed.js' type="text/javascript" charset="utf-8"></script>
  <script src='/static/python.js' type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="/static/codemirror.css">
  <link rel="stylesheet" href="/static/eclipse.css">
  <script>
      choosepython = {
          run_python: function(test_name, code, stdout, checks) {
              $(stdout).val("");
              $(checks).html("");
              $.ajax({
                  type: "POST",
                  dataType: "json",
                  url: "/gym/run/{{ ex.id }}/",
                  data: {
                      code: $(code).val(),
                      csrfmiddlewaretoken: "{{ csrf_token }}"
                  },
                  success: function(obj) {
                      if (obj.stdout) {
                          $(stdout).show();
                      }
                      $(stdout).val(obj.stdout);
                      $(obj.checks).each( function(i, res) {
                          if (res[0] === "ERROR") {
                              $(checks).append($("<pre class='ERROR'>" + res[2] + "</pre>"));
                          }
                          else {
                              var p = $("<p class='" + res[0] + "'>" + res[1] + "</p>");
                              $(checks).append(p)
                              if (res[2]) {
                                  p.append($("<span class='whathappened'> &nbsp;" + res[2] + "</span>"));
                              }
                          }
                      });
                  }
              });
          }
      };

      $(function() {
          choosepython.codemirror = CodeMirror.fromTextArea($("#editor")[0], {
              mode: {
                  name: "python",
                  version: 2,
                  singleLineStringErrors: true
                  },
              theme: "eclipse",
              lineNumbers: true,
              tabMode: "shift",
              indentUnit: 4
              });

          $('.run_code').click(
              function(ev) {
                  choosepython.codemirror.save();
                  var btn = ev.target;
                  var par = $(btn).parents(".exercise");
                  var test_name = par.attr("id");
                  choosepython.run_python(test_name, par.find(".code"), par.find(".stdout"), par.find(".checks"));
              }
          );
          $('.highlight').click(
              function(ev) {
                  choosepython.codemirror.setLineClass(2, "errorline");
              }
          );
      });
  </script>
{% endblock head %}

{% block main %}
  {{ ex.text|safe }}

  <div class='exercise'>
    <textarea class='code' id='editor'></textarea>
    <p><input class='run_code' type='button' value='Run it'></input></p>
    <textarea class='stdout' style='display:none' cols='80' rows='10'>
    </textarea>
    <div class='checks'></div>
  </div>
{% endblock main %}
